// Module included in the following assemblies:
//
// * installing/installing_bare_metal/installing-bare-metal.adoc
// * installing/installing_bare_metal/installing-restricted-networks-bare-metal.adoc
// * installing/installing_ibm_power/installing-ibm-power.adoc
ifeval::["{context}" == "installing-restricted-networks-ibm-z"]
:ibm-z:
endif::[]
ifeval::["{context}" == "installing-ibm-power"]
:ibm-power:
:only-pxe:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-ibm-power"]
:ibm-power:
:only-pxe:
endif::[]

[id="installation-user-infra-machines-pxe_{context}"]
ifndef::only-pxe[]
= Creating {op-system-first} machines by PXE or iPXE booting
endif::only-pxe[]
ifdef::only-pxe[]
= Creating {op-system-first} machines by PXE booting
endif::only-pxe[]

Before you install a cluster on
ifndef::ibm-z,ibm-power[bare metal]
ifdef::ibm-z[IBM Z]
ifdef::ibm-power[IBM Power]
infrastructure that you provision,
you must create {op-system} machines for it to use.
ifndef::only-pxe[]
You can use PXE or iPXE booting to create the machines.
endif::only-pxe[]
ifdef::only-pxe[]
You can use PXE booting to create the machines.
endif::only-pxe[]

.Prerequisites

* Obtain the Ignition config files for your cluster.
ifndef::only-pxe[]
* Familiarity configuring the necessary DHCP, TFTP, and HTTP services for providing PXE or iPXE infrastructure.
endif::only-pxe[]
* Have access to an HTTP server and TFTP server that you can access from your computer.


.Procedure

. Upload the master, worker, and bootstrap Ignition config files that the
installation program created to your HTTP server. Note the URLs of these files.
+
[IMPORTANT]
====
If you plan to add more compute machines to your cluster after you finish
installation, do not delete these files.
====

ifndef::openshift-origin[]
. Obtain the compressed metal RAW image, `kernel`
and `initramfs` files from the
link:https://access.redhat.com/downloads/content/290[Product Downloads] page on the Red
Hat customer portal or the
ifndef::ibm-z,ibm-power[]
link:https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.5/[{op-system} image mirror]
endif::ibm-z,ibm-power[]
ifdef::ibm-z[]
link:https://mirror.openshift.com/pub/openshift-v4/s390x/dependencies/rhcos/[{op-system} image mirror]
endif::ibm-z[]
ifdef::ibm-power[]
link:https://mirror.openshift.com/pub/openshift-v4/ppc64le/dependencies/rhcos/[{op-system} image mirror]
endif::ibm-power[]
page.
+
[IMPORTANT]
====
The {op-system} images might not change with every release of {product-title}.
You must download images with the highest version that is less than or equal
to the {product-title} version that you install. Use the image versions
that match your {product-title} version if they are available.
Only use RAW images for this procedure.
{op-system} qcow2 images are not supported for bare metal installs.
====
+
The file names contain the {product-title} version number.
They resemble the following examples:

** Compressed metal RAW image: `rhcos-<version>-<architecture>-metal.<architecture>.raw.gz`
** `kernel`: `rhcos-<version>-<architecture>-installer-kernel-<architecture>`
** `initramfs`: `rhcos-<version>-<architecture>-installer-initramfs.<architecture>.img`
endif::openshift-origin[]
ifdef::openshift-origin[]
. Obtain the {op-system} images from the
link:https://getfedora.org/en/coreos/download?tab=metal_virtualized&stream=stable[{op-system} Downloads] page
endif::openshift-origin[]

. Upload the RAW image to your HTTP server.

. Upload the additional files that are required for your booting method:
* For traditional PXE, upload the `kernel` and `initramfs` files to your TFTP server.
* For iPXE, upload the `kernel` and `initramfs` files to your HTTP server. 

+
[IMPORTANT]
====
If you plan to add more compute machines to your cluster after you finish
installation, do not delete these files.
====

. Configure the network boot infrastructure so that the machines boot from their
local disks after {op-system} is installed on them.

ifndef::only-pxe[]
. Configure PXE or iPXE installation for the {op-system} images.
endif::only-pxe[]
ifdef::only-pxe[]
. Configure PXE installation for the {op-system} images.
endif::only-pxe[]
+
Modify one of the following example menu entries for your environment and verify
that the image and Ignition files are properly accessible:

** For PXE:
+
----
DEFAULT pxeboot
TIMEOUT 20
PROMPT 0
LABEL pxeboot
    KERNEL rhcos-<version>-<architecture>-installer-kernel-<architecture> <1>
    APPEND ip=dhcp rd.neednet=1 initrd=rhcos-<version>-<architecture>-installer-initramfs.<architecture>.img console=tty0 console=ttyS0 coreos.inst=yes coreos.inst.install_dev=sda coreos.inst.image_url=http://<HTTP_server>/rhcos-<version>-<architecture>-metal.<architecture>.raw.gz coreos.inst.ignition_url=http://<HTTP_server>/bootstrap.ign <2> <3>
----
<1> Specify the location of the `kernel` file available on your TFTP server.
<2> If you use multiple NICs, specify a single interface in the `ip` option.
For example, to use DHCP on a NIC that is named `eno1`, set `ip=eno1:dhcp`.
<3> Specify locations of the {op-system} files that you uploaded to your
HTTP or TFTP server. The `initrd` parameter value is the location of the `initramfs`
file on your TFTP server. The `coreos.inst.image_url` parameter value is the
location of the compressed metal RAW image on your HTTP server, and the
`coreos.inst.ignition_url` parameter value is the location of the bootstrap
Ignition config file on your HTTP server.

ifndef::only-pxe[]
** For iPXE:
+
----
kernel  http://<HTTP_server>/rhcos-<version>-<architecture>-installer-kernel-<architecture> ip=dhcp rd.neednet=1 initrd=rhcos-<version>-<architecture>-installer-initramfs.<architecture>.img console=tty0 console=ttyS0 coreos.inst=yes coreos.inst.install_dev=sda coreos.inst.image_url=http://<HTTP_server>/rhcos-<version>-<architecture>-metal.<architecture>.raw.gz coreos.inst.ignition_url=http://<HTTP_server>/bootstrap.ign <1> <2>
initrd http://<HTTP_server>/rhcos-<version>-<architecture>-installer-initramfs.<architecture>.img <3>
boot
----
<1> Specify locations of the {op-system} files that you uploaded to your
HTTP server. The `kernel` parameter value is the location of the `kernel` file,
the `initrd` parameter value references the name of the `initramfs` file that is
supplied on the following `initrd` line, the `coreos.inst.image_url` parameter value
is the location of the compressed metal RAW image, and the `coreos.inst.ignition_url`
parameter value is the location of the bootstrap Ignition config file.
<2> If you use multiple NICs, specify a single interface in the `ip` option.
For example, to use DHCP on a NIC that is named `eno1`, set `ip=eno1:dhcp`.
<3> Specify the location of the `initramfs` file that you uploaded to your HTTP
server.
endif::only-pxe[]

. If you use UEFI, perform the following actions:
.. Provide the EFI binaries and `grub.cfg` file that are required for booting the system. You need the `shim.efi` binary and the `grubx64.efi` binary.

** Extract the necessary EFI binaries by mounting the {op-system} ISO on
your host and then mounting the `images/efiboot.img` file to your host.
From the `efiboot.img` mount point, you then copy the `EFI/redhat/shimx64.efi` and
`EFI/redhat/grubx64.efi` files to your TFTP server.
+
----
# mkdir -p /mnt/{iso,efiboot}
# mount -o loop rhcos-installer.x86_64.iso /mnt/iso
# mount -o loop,ro /mnt/iso/images/efiboot.img /mnt/efiboot
# cp /mnt/efiboot/EFI/redhat/{shimx64.efi,grubx64.efi} .
# umount /mnt/{efiboot,iso}
----

.. Copy the `EFI/redhat/grub.cfg` file that is included in the {op-system} ISO to your TFTP server.

.. Edit the `grub.cfg` file to include the following arguments:
+
----
menuentry 'Install Red Hat Enterprise Linux CoreOS' --class fedora --class gnu-linux --class gnu --class os {
	linux rhcos-<version>-<architecture>-installer-kernel-<architecture> nomodeset rd.neednet=1 coreos.inst=yes coreos.inst.install_dev=sda coreos.inst.image_url=http://<HTTP_server>/rhcos-<version>-<architecture>-metal.<architecture>.raw.gz coreos.inst.ignition_url=http://<HTTP_server>/bootstrap.ign <1>
	initrd rhcos-<version>-<architecture>-installer-initramfs.<architecture>.img <2>
}
----
<1> The first argument to the `linux` line item is the location of the `kernel`
file that you uploaded to your TFTP server. For the `coreos.inst.image_url` parameter
value, specify the location of the compressed metal RAW image that you uploaded
to your HTTP server. For the `coreos.inst.ignition_url` paramter, specify the location of the
bootstrap Ignition config file that you uploaded to your HTTP server.
<2> Specify the location of the `initramfs` file that you uploaded to your TFTP
server.


. Continue to create the machines for your cluster.
+
[IMPORTANT]
====
You must create the bootstrap and control plane machines at this time. If the
control plane machines are not made schedulable, which is the default, also
create at least two compute machines before you install the cluster.
====

ifeval::["{context}" == "installing-restricted-networks-ibm-z"]
:!ibm-z:
endif::[]
ifeval::["{context}" == "installing-ibm-power"]
:!ibm-power:
:!only-pxe:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-ibm-power"]
:!ibm-power:
:!only-pxe:
endif::[]
